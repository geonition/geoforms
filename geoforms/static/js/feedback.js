!function(){this.user_visible={},this.feature_visible={},this.feature_name2id_list={},this.vizu_features={},this.attribute2id_list={},this.answer2user_list={},this.user2num_answer={},this.user2properties={},this.colors_free=["#dbdb8d","#c7c7c7","#f7b6d2","#c49c94","#c5b0d5","#ff9896","#ffbb78","#aec7e8","#98df8a","#9edae5","#17becf","#bcbd22","#7f7f7f","#e377c2","#8c564b","#9467bd","#d62728","#2ca02c","#ff7f0e","#1f77b4"],this.show_feedback=function(){var e,t,r,a,n,i,l,s,o,u,p,c,d,f,h,m,b,y,g,v,_,k,w,C,x,L,S;return n=function(e){var t,r;t=0;for(r in e)e.hasOwnProperty(r)&&++t;return t},a=function(e){var t,r;t={};for(r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},o=function(e){var t;return"undefined"==typeof e&&(e=colors_free.pop()),t={strokeWidth:5,strokeColor:e,fillColor:"black",cursor:"pointer",fillOpacity:.1,pointRadius:6}},s=function(e){return colors_free.push(e)},y=function(){var e,t,r;return t=0,r={},e=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#9edae5","#98df8a","#aec7e8","#ffbb78","#ff9896","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7","#dbdb8d"],function(a){return a in r||(r[a]=e[t++%20]),{strokeWidth:5,strokeColor:r[a],fillColor:"black",cursor:"pointer",fillOpacity:.1,pointRadius:6}}},f=function(){var e;return e=new OpenLayers.Control.SelectFeature(map.getControl("selectcontrol").layers.concat(map.getLayersByName("Marking Layer")[0]),{hover:!0,highlightOnly:!0,multiple:!0,renderIntent:"highlight",eventListeners:{featurehighlighted:k,featureunhighlighted:u}})},w=function(e){var t,r,a;if(e in C)return C[e];if(r=0,t=void 0,0===e.length)return r;for(a=0;a<e.length;)t=e.charCodeAt(a),r=(r<<5)-r+t,r&=r,a++;for(r=Math.abs(r);r in v;)r++;return v[r]=e,r=r.toString(),C[e]=r,r},r=function(e){var t,r,a;return t=questionnaire.metadata.drawbuttons.hasOwnProperty(e)?questionnaire.metadata.drawbuttons[e].question:e,r=$("<li></li>").addClass("feature-level-ctrl").append($('<input type="checkbox">').addClass("feature-level-ctrl").attr("id",e).attr("value",e).prop("checked",!1).change(x)).append($("<label></label>").addClass("feedback-bold").text(t).attr("for",e)),("checkbox"===(a=questionnaire.metadata.drawbuttons[e].element_type)||"radio"===a||"select"===a)&&r.append($("<ul></ul>").addClass("mini-questionnaire").addClass(e).hide()),$("ul.feature-ctrl-main").append(r)},t=function(e,t){return $("ul.property-ctrl-main").append($("<li></li>").html($("<div></div>").css("padding",0).addClass("feedback-bold").text(t)).append($("<ul></ul>").addClass("question-level-ctrl").addClass(e)))},x=function(e,t){var r,n,i,l,u,p,c,d,f,h,m,b,y;for("undefined"==typeof t&&(t=!1),r=e.target.checked?"checked":"none",p=function(){var t,r,a,n;for(a=feature_name2id_list[e.target.id],n=[],t=0,r=a.length;r>t;t++)i=a[t],n.push(vizu_features[i]);return n}(),"none"===r?(t||(s($('label[for="'+e.target.id+'"]').css("color")),$('label[for="'+e.target.id+'"]').css("color","")),u={}):t?u=o($('label[for="'+e.target.id+'"]').css("color")):(u=o(),$('label[for="'+e.target.id+'"]').css("color",u.strokeColor)),u.display=r,d=0,m=p.length;m>d;d++)n=p[d],n.style=a(u);for(f=0,b=p.length;b>f;f++)n=p[f],user_visible[n.attributes.user]===!1&&(n.style.display="none");for(h=0,y=p.length;y>h;h++)n=p[h],feature_visible[n.attributes.id]===!1&&(n.style.display="none");l=$(e.target).closest("li.feature-level-ctrl").find(".mini-questionnaire"),"none"===r?l.hide():l.show(),map.getLayersByName("Marking Layer")[0].redraw(),c=0;for(n in vizu_features)"none"!==vizu_features[n].style.display&&c++;return $("#visible-feature-count .currently-visible").text(c)},S=function(e){var t,r,a,n,i,l,s;if(r={},0===e.length)return r;for(n=0,l=e.length;l>n;n++)for(t=e[n],i=0,s=t.length;s>i;i++)a=t[i],r[a]=!0;return r},c=function(e){var t,r,a,n,i,l,s,o,u,p,c,d;if(r={},0===e.length)return r;for(p=e[0],n=0,s=p.length;s>n;n++)a=p[n],r[a]=!0;if(1===e.length)return r;for(c=e[0],i=0,o=c.length;o>i;i++)for(a=c[i],d=e.slice(1),l=0,u=d.length;u>l;l++)if(t=d[l],-1===t.indexOf(a)){delete r[a];break}return r},i=function(e){var t,r,a,n,i,l;for(r=[],$(e.target).closest(".mini-questionnaire").find('input[type="checkbox"].attribute-level-ctrl').each(function(){return this.checked?r.push(attribute2id_list[this.value]):void 0}),a=$('.feature-ctrl-andor input[value="and"]').first().prop("checked")?c(r):S(r),l=feature_name2id_list[$(e.target).closest("li.feature-level-ctrl").find("input.feature-level-ctrl").attr("id")],n=0,i=l.length;i>n;n++)t=l[n],feature_visible[t]=t in a?!0:!1;return $(e.target).closest("li.feature-level-ctrl").find("input.feature-level-ctrl").change()},l=function(){var e,t,r,a,i,l,s;s=[],$("input.property-ctrl-boolean").each(function(){return this.checked?s.push(answer2user_list[this.value]):void 0}),r=$('.property-ctrl-andor input[value="and"]').first().prop("checked")?c(s):S(s),a={},$("input.property-ctrl-min").each(function(){return a[this.name]=[parseInt(this.value)]}),$("input.property-ctrl-max").each(function(){return a[this.name].push(parseInt(this.value))});for(l in r)for(i in a)if(t=$("input#exclude-"+i).first().prop("checked"),l in user2num_answer){if(!(i in user2num_answer[l])){if(!t)continue;delete r[l]}e=user2num_answer[l][i],e>=a[i][0]&&e<=a[i][1]||delete r[l]}else{if(!t)continue;delete r[l]}$("#visible-user-count .currently-visible").text(n(r));for(l in user_visible)user_visible[l]=l in r?!0:!1;return $("input.feature-level-ctrl").trigger("change",[!0])},b=function(e){var r,a,i,s,o,u,p,c,d,f,h,m,b,y,g,v;if(a=function(){var e,t,a,n,i,s,o,b,y,g,v,_;if(t=function(){return $("ul."+p).append($("<li></li>").append($("<label></label>").attr("for","min-"+p).append("Min:").append($("<input>").addClass("property-ctrl-min").attr("type","text").attr("id","min-"+p).attr("name",p)).change(l))).append($("<li></li>").append($("<label></label>").attr("for","max-"+p).append("Max:").append($("<input>").addClass("property-ctrl-max").attr("type","text").attr("id","max-"+p).attr("name",p)).change(l))).append($("<li></li>").append($("<label></label>").attr("for","exclude-"+p).append($("<input>").addClass("property-ctrl-exclude").attr("type","checkbox").attr("id","exclude-"+p).attr("name",p)).change(l).append("Exclude people who did not answer")))},e=function(){return i.options.hasOwnProperty(a)?$("ul."+p).append($("<li></li>").append($("<label></label>").attr("for",n).append($("<input>").addClass("property-ctrl-boolean").attr("type","checkbox").attr("id",n).val(n).attr("checked","checked")).change(l).append(i.options[a]))):void 0},i=questionnaire.metadata.elements[f],"checkbox"===i.element_type||"select"===i.element_type||"radio"===i.element_type){for(v=[],s=0,b=r.length;b>s;s++)a=r[s],n=w(p+"-AND-"+a),n in h||(e(),h[n]=!0),null==answer2user_list[n]&&(answer2user_list[n]=Array()),v.push(answer2user_list[n].push(u.user));return v}if("range"===i.element_type||"number"===i.element_type){for(_=[],o=0,y=r.length;y>o;o++)a=r[o],p in m||t(),a=parseInt(a),null==user2num_answer[g=u.user]&&(user2num_answer[g]={}),user2num_answer[u.user][p]=a,null==c[p]&&(c[p]=a),a>c[p]&&(c[p]=a),null==d[p]&&(d[p]=a),a<d[p]?_.push(d[p]=a):_.push(void 0);return _}},e.entry){for(o={user:!0,time:!0,id:!0,group:!0},m={},h={},c={},d={},v=e.entry,b=0,y=v.length;y>b;b++)if(u=v[b],!("form_values"in u)){null==user2properties[g=u.user]&&(user2properties[g]={});for(p in u)r=u[p],p in o||(f=p.split("t201")[0],p=w(f),p in m||t(p,f),r instanceof Array||(r=[r]),user2properties[u.user][f]=r,a(),m[p]=!0)}for(p in c)i=c[p],$('input.property-ctrl-max[name="'+p+'"]').val(i);for(p in d)s=d[p],$('input.property-ctrl-min[name="'+p+'"]').val(s);return $("ul.property-ctrl-main ul").filter(function(){return $(this).find("li").length<2}).parent().remove(),$("#property-ctrl .loading").remove(),$(".property-ctrl-general").prepend($("<div>/</div>").attr("id","visible-user-count").append($("<span></span>").addClass("total")).prepend($("<span></span>").addClass("currently-visible"))),$("#visible-user-count .currently-visible").text(n(user2properties)),$("#visible-user-count .total").text(n(user2properties))}},m=function(t){var a,l,s,o,u,p,c,f,h,m,b,y,v,_,k;if(t.features){for(m=map.getLayersByName("Marking Layer")[0],f=new OpenLayers.Format.GeoJSON,v=new OpenLayers.Projection(t.crs.properties.code),_=new OpenLayers.Projection(map.getProjection()),$("#feature-ctrl").append($("<ul></ul>").addClass("feature-ctrl-main")),$("#feature-ctrl").prepend("<h2>Choose features to show</h2>"),$("#property-ctrl").prepend("<h2>Filter respondents</h2>"),y={},h=0;h<t.features.length;){c=f.parseFeature(t.features[h]),p=c.attributes.name,c.geometry.transform(v,_),c.lonlat=gnt.questionnaire.get_popup_lonlat(c.geometry),c.style={},c.style.display="none",c.attributes.id=h,c=g(c),vizu_features[h]=c,user_visible[c.attributes.user]=!0,p in feature_name2id_list||(feature_name2id_list[p]=Array(),r(p,c)),feature_name2id_list[p].push(h),b=questionnaire.metadata.drawbuttons[p].elements;for(a in c.attributes.form_values)if("checkbox"===(k=b[a].element_type)||"radio"===k||"select"===k){u=w([p,a].join("-AND-")),u in y||(y[u]=!0,$("."+p).append($("<li></li>").addClass("attr-ctrl").append($("<div></div>").css("color",c.style.strokeColor).html(a)).append($("<ul></ul>").addClass(u))));for(s in c.attributes.form_values[a]){if(!d(s)){if(!isNaN(Number(s)))continue;s="*long-answer"}l=w([p,a,s].join("-AND-")),l in attribute2id_list||(attribute2id_list[l]=Array(),$("."+u).append($("<li></li>").append($('<input type="checkbox">').addClass("attribute-level-ctrl").attr("id",l).attr("value",l).attr("checked","checked").change(i)).append($("<label></label>").css("color",c.style.strokeColor).text(s).attr("for",l)))),attribute2id_list[l].push(h)}}m.addFeatures(c),h+=1}for(o in vizu_features)feature_visible[o]=!0;return e(),$(".attr-ctrl").filter(function(){return $(this).find("li").length<2}).remove(),$('.feature-ctrl-andor input[value="or"]').prop("checked",!0),$(".feature-ctrl-andor input").change(L),$("#feature-ctrl .loading").remove(),$(".feature-ctrl-general").prepend($("<div>/</div>").attr("id","visible-feature-count").append($("<span></span>").addClass("total")).prepend($("<span></span>").addClass("currently-visible"))),$("#visible-feature-count .total").text(n(feature_visible))}},L=function(){return $("li.feature-level-ctrl").each(function(){return $(this).find("input.attribute-level-ctrl").first().change()})},d=function(e){return-1===e.indexOf(" ")&&e.charCodeAt(0)>="a".charCodeAt(0)&&e.charCodeAt(0)<="z".charCodeAt(0)?!0:!1},u=function(){return $("div.analysis_popup").hide()},k=function(e){var t,r,a,n,i,l,s,o,u,p,c;$(".analysis_popup").html("").hide(),$(".feature_comments").append('<div class="name">'+e.feature.attributes.name+"</div>"),a=e.feature.attributes.form_values;for(n in a){$(".feature_comments").append('<div class="attribute-name">'+n+"</div>"),l=$("<ul></ul>");for(o in a[n])l.append($("<li></li>").html(o));$(".feature_comments").append(l)}s=e.feature.attributes.user,$(".user_info").prepend($("<div>user: "+s+"</div>").addClass("username")),c=user2properties[s];for(i in c){for(r=c[i],$(".user_info").append('<div class="attribute-name">'+i+"</div>"),l=$("<ul></ul>"),u=0,p=r.length;p>u;u++)t=r[u],l.append($("<li></li>").html(t));$(".user_info").append(l)}return $(".analysis_popup").show()},g=function(e){var t,r,a,n;for(a={},t=e.attributes.form_values,r=0;r<t.length;)n=t[r],n.name in a||(a[n.name]={}),a[n.name][n.value]=!0,r+=1;return e.attributes.form_values=a,e},e=function(){return $(".mini-questionnaire").prepend($("<label>Check all</label>").css("font-weight","bold").prepend($('<input type="checkbox">').css("margin-right","3px").prop("checked",!0).change(function(e){return $(e.target).closest(".mini-questionnaire").find('input[type="checkbox"]').prop("checked",e.target.checked),$(e.target).closest(".mini-questionnaire").find('input[type="checkbox"].attribute-level-ctrl').last().change()}))),$(".property-ctrl-general").append($("<label>Check all</label>").css("font-weight","bold").prepend($('<input type="checkbox">').css("margin-right","3px").prop("checked",!0).change(function(e){return $("input.property-ctrl-boolean").prop("checked",e.target.checked),l()})))},v={},C={},$(".property-ctrl-andor input").change(l),$('.property-ctrl-andor input[value="or"]').first().prop("checked",!0),$(".span_right").css("left","570px"),$(".span_left").css("width","570px"),map.updateSize(),$("a#feedback").hide(),map.getLayersByName("Route Layer")[0].setVisibility(!1),map.getLayersByName("Point Layer")[0].setVisibility(!1),map.getLayersByName("Area Layer")[0].setVisibility(!1),h=new OpenLayers.Layer.Vector("Marking Layer",{styleMap:new OpenLayers.StyleMap({"default":{strokeWidth:3,strokeColor:"red",cursor:"pointer",fillColor:"#aaaaff",fillOpacity:.3,pointRadius:5},highlight:{strokeWidth:3,strokeColor:"#555555",cursor:"pointer",fillColor:"#555555",fillOpacity:.3,pointRadius:5}})}),map.addLayer(h),_=map.getControl("selectcontrol"),_.setLayer(_.layers.concat(h)),$("#property-ctrl").prepend('<div class="loading">Loading data... please wait</div>'),$("#feature-ctrl").prepend('<div class="loading">Loading data... please wait</div>'),$.get("/questionnaire_admin/meta/"+questionnaire.q_id,function(e){return questionnaire.metadata=e,gnt.geo.get_features("@all",data_group,"",{success:m}),gnt.geo.get_properties("@all",data_group,"@null","@all",{success:b})}),p=f(),map.addControl(p),p.activate()},this.make_sld_getter=function(){var e,t,r,a;return t=0,r={},e=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],a='<?xml version="1.0" encoding="ISO-8859-1"?><StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd" xmlns="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"> <NamedLayer> <Name>NAME</Name> <UserStyle> <Title>SLD Cook Book: Line w2th border</Title> <FeatureTypeStyle> <Rule> <LineSymbolizer> <Stroke> <CssParameter name="stroke">#333333</CssParameter> <CssParameter name="stroke-width">7</CssParameter> <CssParameter name="stroke-linecap">round</CssParameter> </Stroke> </LineSymbolizer> </Rule> </FeatureTypeStyle> <FeatureTypeStyle> <Rule> <LineSymbolizer> <Stroke> <CssParameter name="stroke">COLOR</CssParameter> <CssParameter name="stroke-width">5</CssParameter> <CssParameter name="stroke-linecap">round</CssParameter> </Stroke> </LineSymbolizer> </Rule> </FeatureTypeStyle> </UserStyle> </NamedLayer></StyledLayerDescriptor>',function(n){var i,l;return i="",n in r?i=r[n]:(i=e[t++%10],r[n]=i),l=a.replace("NAME",n),l.replace("COLOR",i)}}}.call(this);