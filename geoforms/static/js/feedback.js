!function(){this.user_visible={},this.feature_visible={},this.feature_name2id_list={},this.vizu_features={},this.attribute2id_list={},this.answer2user_list={},this.user2num_answer={},this.user2properties={},this.colors_free=["#dbdb8d","#c7c7c7","#f7b6d2","#c49c94","#c5b0d5","#ff9896","#ffbb78","#aec7e8","#98df8a","#9edae5","#17becf","#bcbd22","#7f7f7f","#e377c2","#8c564b","#9467bd","#d62728","#2ca02c","#ff7f0e","#1f77b4"],this.show_feedback=function(){var e,t,r,a,n,i,l,s,o,u,p,c,d,f,h,m,b,y,g,v,_,k,w,C,x,L,q,O,S,P,N,A;return e={user:!0,time:!0,id:!0,group:!0},s=function(e){var t,r;t=0;for(r in e)e.hasOwnProperty(r)&&++t;return t},l=function(e){var t,r;t={};for(r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},c=function(e){var t,r,a;a=function(e,t){var r;return r=0,r="0:"===e.slice(0,3)?9999:"0:"===t.slice(0,3)?-9999:e.length-t.length},t=[];for(r in e)e.hasOwnProperty(r)&&t.push(r);return t.sort(a)},d=function(e){var t;return"undefined"==typeof e&&(e=colors_free.pop()),t={strokeWidth:3,strokeColor:e,fillColor:e,cursor:"pointer",fillOpacity:1,pointRadius:4}},p=function(e){return colors_free.push(e)},k=function(){var e,t,r;return t=0,r={},e=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#9edae5","#98df8a","#aec7e8","#ffbb78","#ff9896","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7","#dbdb8d"],function(a){return a in r||(r[a]=e[t++%20]),{strokeWidth:5,strokeColor:r[a],fillColor:"black",cursor:"pointer",fillOpacity:.1,pointRadius:6}}},y=function(){var e;return e=new OpenLayers.Control.SelectFeature(map.getControl("selectcontrol").layers.concat(map.getLayersByName("Marking Layer")[0]),{hover:!0,highlightOnly:!0,multiple:!0,renderIntent:"highlight",eventListeners:{featurehighlighted:q,featureunhighlighted:f}})},O=function(e){var t,r,a;if(e in S)return S[e];if(r=0,t=void 0,0===e.length)return r;for(a=0;a<e.length;)t=e.charCodeAt(a),r=(r<<5)-r+t,r&=r,a++;for(r=Math.abs(r);r in x;)r++;return x[r]=e,r=r.toString(),S[e]=r,r},i=function(e,t){var r;return r=$("<li></li>").addClass("feature-level-ctrl").append($('<input type="checkbox">').addClass("feature-level-ctrl").attr("id",e).attr("value",e).prop("checked",!1).change(P)).append($("<label></label>").addClass("feedback-bold").text(t.attributes.original_name).attr("for",e)),t.attributes.popup_has_multiple_choice_questions&&r.append($("<ul></ul>").addClass("mini-questionnaire").addClass(e).hide()),$("ul.feature-ctrl-main").append(r)},r=function(e,t){var r;return r=questionnaire.metadata.elements,r.hasOwnProperty(t)&&r[t].hasOwnProperty("question")&&(t=r[t].question),$("ul.property-ctrl-main").append($("<li></li>").html($("<div></div>").css("padding",0).addClass("feedback-bold").html(t)).append($("<ul></ul>").addClass("question-level-ctrl").addClass(e)))},P=function(e,t){var r,a,n,i,s,o,u,c,f,h,m,b,y;for("undefined"==typeof t&&(t=!1),r=e.target.checked?"checked":"none",o=function(){var t,r,a,i;for(a=feature_name2id_list[e.target.id],i=[],t=0,r=a.length;r>t;t++)n=a[t],i.push(vizu_features[n]);return i}(),"none"===r?(t||(p($('label[for="'+e.target.id+'"]').css("color")),$('label[for="'+e.target.id+'"]').css("color","")),s={}):t?s=d($('label[for="'+e.target.id+'"]').css("color")):(s=d(),$('label[for="'+e.target.id+'"]').css("color",s.strokeColor)),s.display=r,c=0,m=o.length;m>c;c++)a=o[c],a.style=l(s);for(f=0,b=o.length;b>f;f++)a=o[f],user_visible[a.attributes.user]===!1&&(a.style.display="none");for(h=0,y=o.length;y>h;h++)a=o[h],feature_visible[a.attributes.id]===!1&&(a.style.display="none");i=$(e.target).closest("li.feature-level-ctrl").find(".mini-questionnaire"),"none"===r?i.hide():i.show(),map.getLayersByName("Marking Layer")[0].redraw(),u=0;for(a in vizu_features)"none"!==vizu_features[a].style.display&&u++;return $("#visible-feature-count .currently-visible").text(u)},A=function(e){var t,r,a,n,i,l,s;if(r={},0===e.length)return r;for(n=0,l=e.length;l>n;n++)for(t=e[n],i=0,s=t.length;s>i;i++)a=t[i],r[a]=!0;return r},m=function(e){var t,r,a,n,i,l,s,o,u,p,c,d;if(r={},0===e.length)return r;for(p=e[0],n=0,s=p.length;s>n;n++)a=p[n],r[a]=!0;if(1===e.length)return r;for(c=e[0],i=0,o=c.length;o>i;i++)for(a=c[i],d=e.slice(1),l=0,u=d.length;u>l;l++)if(t=d[l],-1===t.indexOf(a)){delete r[a];break}return r},o=function(e){var t,r,a,n,i,l;for(r=[],$(e.target).closest(".mini-questionnaire").find('input[type="checkbox"].attribute-level-ctrl').each(function(){return this.checked?r.push(attribute2id_list[this.value]):void 0}),a=$('.feature-ctrl-andor input[value="and"]').first().prop("checked")?m(r):A(r),l=feature_name2id_list[$(e.target).closest("li.feature-level-ctrl").find("input.feature-level-ctrl").attr("id")],n=0,i=l.length;i>n;n++)t=l[n],feature_visible[t]=t in a?!0:!1;return $(e.target).closest("li.feature-level-ctrl").find("input.feature-level-ctrl").trigger("change",[!0])},u=function(){var e,t,r,a,n,i,l;l=[],$("input.property-ctrl-boolean").each(function(){return this.checked?l.push(answer2user_list[this.value]):void 0}),r=$('.property-ctrl-andor input[value="and"]').first().prop("checked")?m(l):A(l),a={},$("input.property-ctrl-min").each(function(){return a[this.name]=[parseInt(this.value)]}),$("input.property-ctrl-max").each(function(){return a[this.name].push(parseInt(this.value))});for(i in r)for(n in a)if(t=$("input#exclude-"+n).first().prop("checked"),i in user2num_answer){if(!(n in user2num_answer[i])){if(!t)continue;delete r[i]}e=user2num_answer[i][n],e>=a[n][0]&&e<=a[n][1]||delete r[i]}else{if(!t)continue;delete r[i]}$("#visible-user-count .currently-visible").text(s(r));for(i in user_visible)user_visible[i]=i in r?!0:!1;return $("input.feature-level-ctrl").trigger("change",[!0])},a=function(e,t,r,a){return e.options.hasOwnProperty(r)?$("ul."+t).append($("<li></li>").append($("<label></label>").attr("for",a).append($("<input>").addClass("property-ctrl-boolean").attr("type","checkbox").attr("id",a).val(a).attr("checked","checked")).change(u).append(e.options[r]))):void 0},n=function(e,t){return $("ul."+t).append($("<li></li>").append($("<label></label>").attr("for","min-"+t).append("Min:").append($("<input>").addClass("property-ctrl-min").attr("type","text").attr("id","min-"+t).attr("name",t)).change(u))).append($("<li></li>").append($("<label></label>").attr("for","max-"+t).append("Max:").append($("<input>").addClass("property-ctrl-max").attr("type","text").attr("id","max-"+t).attr("name",t)).change(u))).append($("<li></li>").append($("<label></label>").attr("for","exclude-"+t).append($("<input>").addClass("property-ctrl-exclude").attr("type","checkbox").attr("id","exclude-"+t).attr("name",t)).change(u).append("Exclude people who did not answer")))},_=function(t){var i,l,o,u,p,c,d,f,h,m,b,y,g,v,_;if(l=function(){var e,t,r,l,s,o,u,y,g,v,$,_;if(questionnaire.metadata.elements.hasOwnProperty(d)){if(r=questionnaire.metadata.elements[d],"checkbox"===(g=r.element_type)||"select"===g||"radio"===g){for($=[],l=0,o=i.length;o>l;l++)e=i[l],t=O(d+"-AND-"+e),t in m||(a(r,c,e,t),m[t]=!0),null==answer2user_list[t]&&(answer2user_list[t]=Array()),$.push(answer2user_list[t].push(p.user));return $}if("range"===(v=r.element_type)||"number"===v){for(_=[],s=0,u=i.length;u>s;s++)e=i[s],c in b||n(r,c),e=parseInt(e),null==user2num_answer[y=p.user]&&(user2num_answer[y]={}),user2num_answer[p.user][c]=e,null==f[c]&&(f[c]=e),e>f[c]&&(f[c]=e),null==h[c]&&(h[c]=e),e<h[c]?_.push(h[c]=e):_.push(void 0);return _}}},t.entry){for(b={},m={},f={},h={},_=t.entry,y=0,g=_.length;g>y;y++)if(p=_[y],!("form_values"in p)){p=C(p),null==user2properties[v=p.user]&&(user2properties[v]={});for(d in p)i=p[d],d in e||(c=O(d),c in b||r(c,d),i instanceof Array||(i=[i]),user2properties[p.user][d]=i,l(),b[c]=!0)}for(d in f)o=f[d],$('input.property-ctrl-max[name="'+d+'"]').val(o);for(d in h)u=h[d],$('input.property-ctrl-min[name="'+d+'"]').val(u);return $("ul.property-ctrl-main ul").filter(function(){return $(this).find("li").length<2}).parent().remove(),$("#property-ctrl .loading").remove(),$(".property-ctrl-general").prepend($("<div>/</div>").attr("id","visible-user-count").append($("<span></span>").addClass("total")).prepend($("<span></span>").addClass("currently-visible")).append($("<span> respondents match your current filter</span>"))),$("#visible-user-count .currently-visible").text(s(user2properties)),$("#visible-user-count .total").text(s(user2properties))}},C=function(t){var r,a,n,i;for(a in t)i=t[a],a in e||(n=a,r=questionnaire.metadata.elements,a in r&&("question"in r[a]?n=r[a].question:"range"===r[a].element_type&&(n="0: "+r[a].min_label+"<br />100: "+r[a].max_label),r[n]=r[a],"range"===r[a].element_type&&(t[a]=Math.round(i)),t[n]=t[a],delete t[a]));return t},v=function(e){var r,a,n,l,u,p,c,d,f,h,m,b,y,g,v;if(e.features){for(h=map.getLayersByName("Marking Layer")[0],d=new OpenLayers.Format.GeoJSON,y=new OpenLayers.Projection(e.crs.properties.code),g=new OpenLayers.Projection(map.getProjection()),b={},f=0;f<e.features.length;){c=d.parseFeature(e.features[f]),p=c.attributes.name,c.geometry.transform(y,g),c.lonlat=gnt.questionnaire.get_popup_lonlat(c.geometry),c.style={},c.style.display="none",c.attributes.id=f,c=w(c),vizu_features[f]=c,user_visible[c.attributes.user]=!0,p in feature_name2id_list||(feature_name2id_list[p]=Array(),i(p,c)),feature_name2id_list[p].push(f),m=questionnaire.metadata.drawbuttons[p].elements;for(r in c.attributes.form_values)if("checkbox"===(v=m[r].element_type)||"radio"===v||"select"===v){u=O([p,r].join("-AND-")),u in b||(b[u]=!0,$("."+p).append($("<li></li>").addClass("attr-ctrl").append($("<div></div>").html(r)).append($("<ul></ul>").addClass(u))));for(n in c.attributes.form_values[r])a=O([p,r,n].join("-AND-")),a in attribute2id_list||(attribute2id_list[a]=Array(),$("."+u).append($("<li></li>").append($('<input type="checkbox">').addClass("attribute-level-ctrl").attr("id",a).attr("value",a).attr("checked","checked").change(o)).append($("<label></label>").text(n).attr("for",a)))),attribute2id_list[a].push(f)}h.addFeatures(c),f+=1}for(l in vizu_features)feature_visible[l]=!0;return t(),$(".attr-ctrl").filter(function(){return $(this).find("li").length<2}).remove(),$('.feature-ctrl-andor input[value="or"]').prop("checked",!0),$(".feature-ctrl-andor input").change(N),$("#feature-ctrl .loading").remove(),$(".feature-ctrl-general").prepend($("<div>/</div>").attr("id","visible-feature-count").append($("<span></span>").addClass("total")).prepend($("<span></span>").addClass("currently-visible")).append($("<span> markings match your current filter</span>"))),$("#visible-feature-count .total").text(s(feature_visible))}},N=function(){return $("li.feature-level-ctrl").each(function(){return $(this).find("input.attribute-level-ctrl").first().change()})},b=function(e){return-1===e.indexOf(" ")&&e.charCodeAt(0)>="a".charCodeAt(0)&&e.charCodeAt(0)<="z".charCodeAt(0)?!0:!1},f=function(){return $("div.analysis_popup").hide()},q=function(e){var t,r,a,n,i,l,s,o,u,p;$(".analysis_popup").html("").hide(),$(".feature_comments").append('<div class="name">'+e.feature.attributes.original_name+"</div>"),r=e.feature.attributes.form_values;for(a in r){$(".feature_comments").append('<div class="attribute-name">'+a+"</div>"),i=$("<ul></ul>");for(s in r[a])i.append($("<li></li>").html(s));$(".feature_comments").append(i)}for(l=e.feature.attributes.user,$(".user_info").prepend($("<div>Responses to other questions</div>").addClass("username")),$(".user_info").append($("<ul></ul>")),p=c(user2properties[l]),o=0,u=p.length;u>o;o++)n=p[o],t=user2properties[l][n],$(".user_info ul").append($('<li class="popup-property"><span class="attribute-name">'+n+" </span></li>").append(t.join(", ")));return $(".analysis_popup").show()},w=function(e){var t,r,a,n,i,l,s,o,u,p,c,d,f,h,m,b,y;if(i=e.attributes.name,t={},i in questionnaire.metadata.drawbuttons?(t=questionnaire.metadata.drawbuttons[i],o=t.question.trim(),questionnaire.metadata.drawbuttons[o]=questionnaire.metadata.drawbuttons[i]):o=i,e.attributes.original_name=o,u=!1,"elements"in t){m=t.elements;for(a in m)r=m[a],("checkbox"===(b=r.element_type)||"radio"===b||"select"===b)&&(u=!0)}for(e.attributes.popup_has_multiple_choice_questions=u,s={},l=e.attributes.form_values,f=0,h=l.length;h>f;f++)p=l[f],c=p.name,d=p.value,p.name in t.elements&&(n=t.elements[p.name],c=n.question,t.elements[c]=t.elements[p.name],("checkbox"===(y=n.element_type)||"radio"===y||"select"===y)&&p.value in n.options&&(d=n.options[p.value]),"range"===n.element_type&&(d=Math.round(p.value))),null==s[c]&&(s[c]={}),s[c][d]=!0;return e.attributes.form_values=s,e},t=function(){return $(".mini-questionnaire").prepend($("<label>Check all</label>").css("font-weight","bold").prepend($('<input type="checkbox">').css("margin-right","3px").prop("checked",!0).change(function(e){return $(e.target).closest(".mini-questionnaire").find('input[type="checkbox"]').prop("checked",e.target.checked),$(e.target).closest(".mini-questionnaire").find('input[type="checkbox"].attribute-level-ctrl').last().trigger("change",[!0])}))),$(".property-ctrl-general").append($("<label>Check all</label>").css("font-weight","bold").prepend($('<input type="checkbox">').css("margin-right","3px").prop("checked",!0).change(function(e){return $("input.property-ctrl-boolean").prop("checked",e.target.checked),u()})))},x={},S={},$(".property-ctrl-andor input").change(u),$('.property-ctrl-andor input[value="or"]').first().prop("checked",!0),map.updateSize(),$("a#feedback").hide(),map.getLayersByName("Route Layer")[0].setVisibility(!1),map.getLayersByName("Point Layer")[0].setVisibility(!1),map.getLayersByName("Area Layer")[0].setVisibility(!1),g=new OpenLayers.Layer.Vector("Marking Layer",{styleMap:new OpenLayers.StyleMap({"default":{strokeWidth:3,strokeColor:"red",cursor:"pointer",fillColor:"#aaaaff",fillOpacity:.3,pointRadius:5},highlight:{strokeWidth:3,strokeColor:"#555555",cursor:"pointer",fillColor:"#555555",fillOpacity:.3,pointRadius:5}})}),map.addLayer(g),L=map.getControl("selectcontrol"),L.setLayer(L.layers.concat(g)),$("#property-ctrl").prepend('<div class="loading">Loading data... please wait</div>'),$("#feature-ctrl").prepend('<div class="loading">Loading data... please wait</div>'),$.get("/questionnaire_admin/meta/"+questionnaire.q_id,function(e){return questionnaire.metadata=e,gnt.geo.get_features("@all",data_group,"",{success:v}),gnt.geo.get_properties("@all",data_group,"@null","@all",{success:_})}),h=y(),map.addControl(h),h.activate()},this.make_sld_getter=function(){var e,t,r,a;return t=0,r={},e=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],a='<?xml version="1.0" encoding="ISO-8859-1"?><StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd" xmlns="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"> <NamedLayer> <Name>NAME</Name> <UserStyle> <Title>SLD Cook Book: Line w2th border</Title> <FeatureTypeStyle> <Rule> <LineSymbolizer> <Stroke> <CssParameter name="stroke">#333333</CssParameter> <CssParameter name="stroke-width">7</CssParameter> <CssParameter name="stroke-linecap">round</CssParameter> </Stroke> </LineSymbolizer> </Rule> </FeatureTypeStyle> <FeatureTypeStyle> <Rule> <LineSymbolizer> <Stroke> <CssParameter name="stroke">COLOR</CssParameter> <CssParameter name="stroke-width">5</CssParameter> <CssParameter name="stroke-linecap">round</CssParameter> </Stroke> </LineSymbolizer> </Rule> </FeatureTypeStyle> </UserStyle> </NamedLayer></StyledLayerDescriptor>',function(n){var i,l;return i="",n in r?i=r[n]:(i=e[t++%10],r[n]=i),l=a.replace("NAME",n),l.replace("COLOR",i)}}}.call(this);