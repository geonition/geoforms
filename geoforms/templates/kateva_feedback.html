{% extends "base_map.html" %}
{% load i18n %}

{% block stylesheet %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/questionnaire.css" />
{% endblock %}


{% block content %}

<ul class="feature_comments">
</ul>
    
<ul class="breadcrumb">
    <li class="disk hover base_bgcolor" onclick="window.location = '{% url dashboard %}'">
        <a href="{% url dashboard %}">
            <h3>
            {% trans 'Questionnaires' %}
            </h3>
        </a>
    </li>
    <li class="separator base_bgcolor"></li>
    <li class="active base_textcolor">
        <h3>
            {{ questionnaire.name }}
        </h3>
    </li>
</ul>
<p>
Samanväriset pallukat ovat samaan kysymykseen liittyviä paikannuksia. Viemällä hiiren pallukan
päälle voit tarkastella vastausta yksityiskohtaisemmin.
</p>
{% endblock content %}

{% block javascript %}
<script src="{{ STATIC_URL }}js/libs/OpenLayers-gnt.js"></script>
<script type="text/javascript" src="{% url api_javascript %}"></script>
<script type="text/javascript" src="{% url map_js map_slug_name=map_slug %}"></script>
<script type="text/javascript">
var data_group = 'Q-{{ questionnaire.slug }}';
var questionnaire_area = {{ questionnaire.area.json|safe }};

// instead of using global varibles start using this object

var questionnaire = {
    'data_group': 'Q-{{ questionnaire.slug }}',
    'questionnaire_area': {{ questionnaire.area.json|safe }},
    'show_area': {{ questionnaire.show_area|lower }},
    'scale_visible_area': {{ questionnaire.scale_visible_area }}
}

function count_results() {
    var number_of_properties = 0;
    for(var val in gnt.questionnaire.npvalues) {
        number_of_properties++;
    }
    var number_of_places = map.getLayersByName('Point Layer')[0].features.length;
    var number_of_routes = map.getLayersByName('Route Layer')[0].features.length;
    var number_of_areas = map.getLayersByName('Area Layer')[0].features.length;
    var number_of_features = number_of_places + number_of_routes + number_of_areas;
    
    if( number_of_features === 0 ) {
        $('span.number_of_features').html("");
    } else if( number_of_features === 1) {
        $('span.number_of_features').html('{% trans "You marked one place" %}');
    } else {
        $('span.number_of_features').html('{% trans "You marked" %} ' + number_of_features + ' {% trans "places" %}');
    }
    if( number_of_properties === 0 ) {
        $('span.number_of_properties').html("");
    } else if( number_of_features !== 0) {
        if( number_of_properties === 1) {
            $('span.number_of_properties').html('{% trans "and answered one question" %}');
        } else {
            $('span.number_of_properties').html('{% trans "and answered" %} ' + number_of_properties + ' {% trans "questions" %}');
        }
    } else if ( number_of_properties === 1) {
        $('span.number_of_properties').html('{% trans "You answered one question" %}');
    } else {
        $('span.number_of_properties').html('{% trans "You answered" %} ' + number_of_properties + ' {% trans "questions" %}');
    }
    
    if ( number_of_properties === 0 && number_of_features !== 0 ) {    
        $( 'span.number_of_features' ).append('.');
    } else if ( number_of_properties !== 0 ) {    
        $( 'span.number_of_properties' ).append('.');
    }
}

jQuery(document).ready(function() {
    gnt.questionnaire.init('#forms', '', '#forms', questionnaire_area, data_group, function() {
        
        //count the amount of answeres given
        count_results();
        
        $('#forms').bind('accordionchangestart', function(event, ui) {
            count_results();
        });
        // KATEVA START
        function make_style_getter(){
            var current = 0;
            var name2style = {};
            var colorlist = ['#CC0000',
                            '#990099',
                            '#3333CC',
                            '#0099FF',
                            '#29A3A3',
                            '#297A29',
                            '#33D633',
                            '#E6E600',
                            '#663300'];
            return function(name){
                if (!(name in name2style))
                {
                    name2style[name] = { 
                        strokeWidth: 5,
                        strokeColor: colorlist[current++ % 10],
                        fillColor: 'black',
                        cursor: 'pointer',
                        fillOpacity : 0.1,
                        pointRadius: 6
                        };
                };
                return name2style[name];
            };
        };
        var get_style_for_name = make_style_getter();


            var i,
                highlightCtrl,
                select_control,
                others_feature_collected = false,
                otherLayer = new OpenLayers.Layer.Vector("Others Layer", {
                    styleMap: new OpenLayers.StyleMap({
                        'default': {
                            strokeWidth: 3,
                            strokeColor: 'red',
                            //strokeColor: '#aaaaff',
                            cursor: 'pointer',
                            fillColor: '#aaaaff',
                            fillOpacity: 0.3,
                            pointRadius: 5
                        },
                        'highlight': {
                            strokeWidth: 3,
                            strokeColor: '#555555',
                            cursor: 'pointer',
                            fillColor: '#555555',
                            fillOpacity: 0.3,
                            pointRadius: 5
                        }
                    })
                });

            otherLayer.setVisibility(false);
            map.addLayer(otherLayer);
        var other = map.getLayersByName('Others Layer')[0];
                    if (others_feature_collected === false) {
                        gnt.geo.get_features('@all',
                                             data_group,
                                             '',
                            {
                                'success': function (data) {
                                    if (data.features) {
                                        var gf = new OpenLayers.Format.GeoJSON(),
                                            user,
                                            comment,
                                            i,
                                            feature,
                                            anonymous_regexp,
                                            popupcontent;
                                        for (i = 0; i < data.features.length; i += 1) {
                                            feature = gf.parseFeature(data.features[i]);
                                            //add values losed in parsing should be added again
                                            feature['private'] = data.features[i]['private'];
                                            feature.lonlat = gnt.questionnaire.get_popup_lonlat(feature.geometry);
                                            feature.style = get_style_for_name(feature.attributes.name);
                                            other.addFeatures(feature);
                                            comment = feature.attributes.form_values[0].value;
                                            user = feature.attributes.user;
                                            // set the right content
                                            anonymous_regexp = new RegExp('T[0-9]+.[0-9]+R[0-9]+.[0-9]+');
                                            if (!anonymous_regexp.test(user)) {
                                                $('#other .username').text(user);
                                            }
                                            $('#other .comment').text(comment);
                                            //get the content
                                            popupcontent = $('#other').html();
                                            feature.popupClass = OpenLayers.Popup.FramedCloud;
                                            feature.popup = new OpenLayers.Popup.FramedCloud(
                                                feature.id,
                                                feature.lonlat,
                                                null,
                                                popupcontent,
                                                null,
                                                false
                                            );
                                        }
                                    }
                                }
                            });
                        others_feature_collected = true;
                        other.setVisibility(true);
                        //featureFilter();
                    } else if (others_feature_collected === true) {
                        other.setVisibility(true);
                        //featureFilter();
                    }
                highlightCtrl = new OpenLayers.Control.SelectFeature(
                    map.getControl('selectcontrol').layers.concat(map.getLayersByName('Others Layer')[0]),
                    {
                        hover: true,
                        highlightOnly: true,
                        multiple: true,
                        renderIntent: 'highlight',
                        eventListeners: {
                            featurehighlighted: function (e) {
                                //fix for unhighlight in OpenLayers not always triggering
                                $('ul.feature_comments li').fadeOut(500);
                                var feat_str = '<li class="' +e.feature.id +'">';
                                feat_str += e.feature.attributes.name + '<br />';
                                for (i = 0; i < e.feature.attributes.form_values.length; i += 1) {
                                            feat_str += '<br />' + e.feature.attributes.form_values[i].name +
                                                             '<br />' +
                                                             e.feature.attributes.form_values[i].value +'<br />';
                                        /*} else if ($('ul.feature_comments li.' + e.feature.id + ' span.comment').text() !== e.feature.attributes.form_values[i].value) {
                                            $('ul.feature_comments li.' + e.feature.id + ' span.comment').text(e.feature.attributes.form_values[i].value);
                                        }*/
                                }
                                var create_time_string,
                                    username,
                                    anonymous_regexp,
                                    username = e.feature.attributes.user;
                                    anonymous_regexp = new RegExp('T[0-9]+.[0-9]+R[0-9]+.[0-9]+');
                                    if (anonymous_regexp.test(username) || username === undefined) {
                                        username = '';
                                    }
                                    create_time_string = '';
                                    if (e.feature.attributes.time !== undefined) {
                                        create_time_string = $.datepicker.formatDate('D, d M yy',
                                                                 $.datepicker.parseDate('yy-mm-dd', e.feature.attributes.time.create_time.split('T')[0]));
                                    }
                                feat_str += '<br /><br />' +
                                                 username +
                                                 ' ' +
                                                 create_time_string + '</li>';
                                console.log(feat_str);
                                $('ul.feature_comments').prepend(feat_str);
                                var show_list_item = $('ul.feature_comments li.' + e.feature.id);
                                show_list_item.stop(true, true);
                                show_list_item.fadeIn(500);
                            },
                            featureunhighlighted: function (e) {
                                var hide_list_item = $('ul.feature_comments li.' + e.feature.id);
                                hide_list_item.stop(true, true);
                                hide_list_item.fadeOut(500);
                            }
                        }
                    }
                );
                map.addControl(highlightCtrl);
                highlightCtrl.activate();
                // The select_control needs to be deactivated and activated to make
                // hover and select on different layers to work together (done by setLayer)
                select_control = map.getControl('selectcontrol');
                select_control.setLayer((select_control.layers).concat(otherLayer));

        // KATEVA END
    });
});


</script>
{% endblock javascript %}

