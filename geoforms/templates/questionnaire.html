{% extends "base_map.html" %}
{% load i18n %}

{% block stylesheet %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/questionnaire.css" />
    <!--<link href="{{ STATIC_URL }}css/jquery-ui-1.8.19.custom.css" rel="stylesheet" type="text/css" />-->
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
    
<ul class="breadcrumb">
    <li class="disk hover base_bgcolor">
        <a href="{% url dashboard %}">
            <h3>
            {% trans 'Questionnaires' %}
            </h3>
        </a>
    </li>
    <li class="separator base_bgcolor"></li>
    <li class="active base_textcolor">
        <h3>
            {{ questionnaire.name }}
        </h3>
    </li>
</ul>

<div id="forms">
    {% for form in form_list %}
        <h3 id="section{{ forloop.counter }}" class="section{{ forloop.counter }}">
            <a href="#section{{ forloop.counter }}">{{ form.name }} {{ forloop.counter }}/{{ form_list|length|add:1 }}</a>
        </h3>
        <div>
            <form name="{{ form.slug }}" method="post" action="#">
                {% for key, value in elements.items %}
                    {% if key == form.slug %}
                        {% for element in value %}
                        <div class="form_element">
                            {{ element.html|safe }}
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            
            
            <div class="form_element">
                <p>
                {% if forloop.first %}
                    <a class="next" href="#section{{ forloop.counter|add:'1' }}">{% trans 'Next' %}&rarr;</a>
                {% else %}
                    <a class="previous" href="#section{{ forloop.counter|add:'-1' }}">&larr;{% trans 'Previous' %}</a>
                    <a class="next" href="#section{{ forloop.counter|add:'1' }}">{% trans 'Next' %}&rarr;</a>
                {% endif %}
                </p>
            </div>
            
            </form>
        </div>
        {% if forloop.last %}
            
        <h3 id="section{{ forloop.counter|add:1 }}" class="section{{ forloop.counter|add:1 }}">
            <a href="#section{{ forloop.counter|add:1 }}">{% trans "Your answers and finish" %} {{ forloop.counter|add:1 }}/{{ form_list|length|add:1 }}</a>
        </h3>
        <div>
            <div class="form_element">
                <span class="number_of_features">X</span>
                <span class="number_of_properties">X</span>
            </div>
            <div class="form_element">
                <p>
                {% trans "This is the end of the questionnaire and your answers has been saved. Thank you for your answers! You can still continue modifying your answers by following the previous links or clicking the sections of this questionnaire." %}
                </p>
            </div>
            <br />
            <a class="previous" href="#section{{ forloop.counter }}">&larr;{% trans 'Previous' %}</a>
        </div>
        {% endif %}
    {% endfor %}
</div>

<div id="popups">
    {% for form in popup_list %}
        <div id="{{ form.slug }}">
            
            <form name="{{ form.slug }}" method="post" action="#" class="popupform">
                {% for key, value in elements.items %}
                    {% if key == form.slug %}
                        {% for element in value %}
                        <div class="form_element">
                            {{ element.html|safe }}
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                <button type="button" class="remove">
                    {% trans 'Remove' %}
                </button>
                <button type="button" class="save">
                    {% trans 'Save' %}
                </button>
            </form>
        </div>
    {% endfor %}
</div>


{% endblock %}

{% block javascript %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script src="{{ STATIC_URL }}js/libs/OpenLayers-gnt.js"></script>
<script type="text/javascript" src="{% url api_javascript %}"></script>
<script type="text/javascript" src="{% url map_js map_slug_name=map_slug %}"></script>
<script type="text/javascript">
var data_group = 'Q-{{ questionnaire.slug }}';
var questionnaire_area = {{ questionnaire.area.json|safe }};

function count_results() {
    var number_of_properties = 0;
    for(var val in gnt.questionnaire.npvalues) {
        number_of_properties++;
    }
    var number_of_places = map.getLayersByName('Point Layer')[0].features.length;
    var number_of_routes = map.getLayersByName('Route Layer')[0].features.length;
    var number_of_areas = map.getLayersByName('Area Layer')[0].features.length;
    var number_of_features = number_of_places + number_of_routes + number_of_areas;
    
    if( number_of_features === 0 ) {
        $('span.number_of_features').html("");
    } else if( number_of_features === 1) {
        $('span.number_of_features').html('{% trans "You marked one place" %}');
    } else {
        $('span.number_of_features').html('{% trans "You marked" %} ' + number_of_features + ' {% trans "places" %}');
    }
    if( number_of_properties === 0 ) {
        $('span.number_of_properties').html("");
    } else if( number_of_features !== 0) {
        if( number_of_properties === 1) {
            $('span.number_of_properties').html('{% trans "and answered one question" %}');
        } else {
            $('span.number_of_properties').html('{% trans "and answered" %} ' + number_of_properties + ' {% trans "questions" %}');
        }
    } else if ( number_of_properties === 1) {
        $('span.number_of_properties').html('{% trans "You answered one question" %}');
    } else {
        $('span.number_of_properties').html('{% trans "You answered" %} ' + number_of_properties + ' {% trans "questions" %}');
    }
    
    if ( number_of_properties === 0 && number_of_features !== 0 ) {    
        $( 'span.number_of_features' ).append('.');
    } else if ( number_of_properties !== 0 ) {    
        $( 'span.number_of_properties' ).append('.');
    }
}

jQuery(document).ready(function() {
    gnt.questionnaire.init('#forms', '', '#forms', questionnaire_area, data_group, function() {
        
        //count the amount of answeres given
        count_results();
        
        $('#forms').bind('accordionchangestart', function(event, ui) {
            count_results();
        });
    });
});


</script>
{% endblock javascript %}

